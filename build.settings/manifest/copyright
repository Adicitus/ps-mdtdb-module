Original code (c) Michael Niehaus, with adaptations by Vaughn Miller and Joakim Olsson. 